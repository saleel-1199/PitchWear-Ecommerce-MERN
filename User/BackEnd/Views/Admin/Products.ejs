<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Product Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-[#f8f8f4] text-gray-800">
<header class="bg-[#eff2c8] px-10 py-5 flex items-center justify-between">
  <div class="flex items-center gap-10">
    <h1 class="font-bold text-lg">Pitchwear</h1>
    <p class="text-sm font-semibold">Admin Dashboard</p>
  </div>
  <div class="w-11 h-11 rounded-xl bg-white flex items-center justify-center border">
    <span class="text-lg">ğŸ‘¤</span>
  </div>
</header>

<main class="flex px-10 py-10 gap-10">

<!-- Sidebar -->
<aside class="w-64">
  <p class="text-sm text-gray-500 mb-5">Pitchwear Admin</p>

  <nav class="space-y-2 text-sm">
    <a href="/admin/dashboard" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white">ğŸ  Dashboard</a>
    <a href="/admin/products" class="flex items-center gap-3 px-4 py-2 rounded-lg bg-white font-medium">ğŸ‘• Product Management</a>
    <a href="/admin/orders" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white">ğŸ“¦ Order Management</a>
    <a href="/admin/users" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white">ğŸ‘¥ User Management</a>
    <a href="/admin/analytics" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white">ğŸ“ˆ Analytics</a>
    <a href="/admin/coupons" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white">ğŸ§¾ Coupons</a>
    <a href="/admin/banner" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white">ğŸ·ï¸ Banner</a>
    <a href="/admin/offers" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white">ğŸ Offers</a>
    <a href="/admin/settings" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white">âš™ï¸ Settings</a>
    <a href="/admin/logout" class="flex items-center gap-3 px-4 py-2 rounded-lg text-red-600 font-medium mt-6">â›” Logout</a>
  </nav>
</aside>

<!-- Content -->
<section class="flex-1">

  <div class="flex justify-between items-center">
    <h2 class="text-3xl font-bold">Product Management</h2>
    <a href="/admin/products/add"
       class="bg-[#cdd47b] hover:opacity-90 text-white px-6 py-2 rounded-lg text-sm font-semibold">
      + Add Product
    </a>
  </div>

  <!-- Search Bar -->
  <div class="mt-8">
    <div class="bg-white rounded-xl border px-6 py-3 flex items-center gap-3">
      <span class="text-gray-400">ğŸ”</span>
      <input
        id="searchInput"
        value="<%= search || '' %>"
        placeholder="Search products"
        class="w-full outline-none text-sm"
      />
      <% if (search && search.trim() !== "") { %>
        <a href="/admin/products" class="text-gray-400 font-bold">âœ•</a>
      <% } %>
    </div>
  </div>

  <!-- Table -->
  <div class="bg-white border rounded-xl mt-8 overflow-hidden">
    <table class="w-full text-sm">
      <thead class="bg-gray-50 text-gray-500">
        <tr>
          <th class="text-left px-6 py-4">Product Image</th>
          <th class="text-left px-6 py-4">Product Name</th>
          <th class="text-left px-6 py-4">Price</th>
          <th class="text-left px-6 py-4">Stock</th>
          <th class="text-left px-6 py-4">Status</th>
          <th class="text-center px-6 py-4">Actions</th>
        </tr>
      </thead>

      <tbody>
        <% if (!products || products.length === 0) { %>
          <tr>
            <td colspan="6" class="text-center py-16 text-gray-400">
              No products found
            </td>
          </tr>
        <% } else { %>
          <% products.forEach((p) => { %>

            <%
  const prices = (p.variants || [])
    .filter(v => Number(v.stock) > 0)
    .map(v => Number(v.price));

  const minPrice = prices.length ? Math.min(...prices) : null;
%>


            <tr class="border-t">
              <td class="px-6 py-4">
                <img src="<%= p.images?.[0] || '/images/no-image.png' %>"
                     class="w-12 h-12 object-cover rounded-lg"/>
              </td>

              <td class="px-6 py-4 font-medium">
                <%= p.team %>, <%= p.type %>
              </td>

              <td class="px-6 py-4 text-gray-600">
                <%= minPrice !== null ? `â‚¹${minPrice}` : "â€”" %>
              </td>

              <td class="px-6 py-4 text-gray-600">
                <%= p.totalStock || 0 %>
              </td>

              <td class="px-6 py-4">
                <% if (p.status === "Active") { %>
                  <span class="bg-green-600 text-white px-5 py-1.5 rounded-lg text-xs font-semibold">Active</span>
                <% } else { %>
                  <span class="bg-red-500 text-white px-5 py-1.5 rounded-lg text-xs font-semibold">Inactive</span>
                <% } %>
              </td>

              <td class="px-6 py-4 text-center space-x-2">

  <a href="/admin/products/<%= p._id %>/edit"
     class="bg-[#cdd47b] text-white px-6 py-2 rounded-lg text-xs font-semibold">
    Edit
  </a>

  <a href="/admin/products/<%= p._id %>/inventory"
     class="bg-blue-600 text-white px-6 py-2 rounded-lg text-xs font-semibold">
    Add Stock
  </a>

  <form action="/admin/products/<%= p._id %>/delete"
        method="POST"
        class="inline">
    <button
      onclick="return confirm('Are you sure you want to delete this product?')"
      class="bg-red-600 text-white px-6 py-2 rounded-lg text-xs font-semibold">
      Delete
    </button>
  </form>

</td>

            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- PAGINATION -->
  <% if (totalPages > 1) { %>
    <div class="flex justify-center mt-8 gap-2 text-sm">
      <% if (page > 1) { %>
        <a href="/admin/products?page=<%= page - 1 %>&search=<%= search || '' %>"
           class="px-4 py-2 border rounded-lg bg-white">Prev</a>
      <% } %>

      <% for (let i = 1; i <= totalPages; i++) { %>
        <a href="/admin/products?page=<%= i %>&search=<%= search || '' %>"
           class="px-4 py-2 border rounded-lg <%= i === page ? 'bg-green-600 text-white' : 'bg-white' %>">
          <%= i %>
        </a>
      <% } %>

      <% if (page < totalPages) { %>
        <a href="/admin/products?page=<%= page + 1 %>&search=<%= search || '' %>"
           class="px-4 py-2 border rounded-lg bg-white">Next</a>
      <% } %>
    </div>
  <% } %>

</section>
</main>

<!-- âœ… CURSOR-SAFE DEBOUNCING -->
<script>
  const searchInput = document.getElementById("searchInput");
  let debounceTimer;

  searchInput.addEventListener("input", () => {
    clearTimeout(debounceTimer);

    debounceTimer = setTimeout(() => {
      const value = searchInput.value.trim();
      const url = new URL(window.location.href);

      if (value) {
        url.searchParams.set("search", value);
        url.searchParams.set("page", 1);
      } else {
        url.searchParams.delete("search");
        url.searchParams.set("page", 1);
      }

      history.replaceState({}, "", url);
    }, 500);
  });

  searchInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      const value = searchInput.value.trim();

      window.location.href = value
        ? `/admin/products?search=${encodeURIComponent(value)}`
        : `/admin/products`;
    }
  });
</script>

</body>
</html>
